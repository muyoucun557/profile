# Mysql高可用架构中数据一致性问题

Mysql的备份是异步的，只能保证``最终一致性``(无法保证强一致性。即使是有半同步复制，只能提高一致性，仍然不能变成强一致性)。那在高可用架构中应当缓解这个问题。


## 主备延迟以及原因

执行``show slave status;``，其中``seconds_behind_master``显示的是主备延时的时间。binlog中记录了事务执行结束的时间，通过这个时间于本机时间能得到延迟时间。从机时钟可能与主机不一致，在从机连接主机的时候会同步时钟。

主备延迟主要有下面几种原因
<strong>从机性能比主机差<strong>
需要提升从机的配置
<strong>从机的IO压力大<strong>
从机可能承担了大量了查询工作，比如统计类的。
可以实现一主多从，让更多的从机一起承担查询压力
<strong>大事务<strong>
例如：一个事务中删除了大量的数据；大表的DDL。
将大事务拆分成小事务执行

## 主备切换的场景

主备切换的场景需要考虑到数据一致性带来的影响。有两种主从切换方案

### 可靠性优先

1. 判断从机的延迟时间，如果延迟过大，再次重试。直到延迟在可接受范围内（这个范围是自定义的，可以根据业务自身来决定）。
2. 将主机设置成read_only状态
3. 等延迟时间变成0
4. 将从机设置成可读写，把业务切换到从机
这里的可靠性指的是数据的可靠性，在步骤1中一直等待直到延迟在可接受范围内。
一旦主机设置成read_only状态，存储集群就不再提供写能力，直到延迟变成0。如果在延迟很大的时候就设置成read_only状态，那么不提供写能力的时间就会变长。这种方案优先考虑数据的可靠性，而损失了系统的可用性。

### 可用性优先

直接把主机设置成read_only状态，从机设置成读写状态，业务切换到从机。
由于延迟的存在，会导致数据不一致，但是系统会一直对外提供读写能力。





